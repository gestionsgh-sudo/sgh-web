<!doctype html>
<html lang="es-ES">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SGH | DGT · Alegaciones (20 días) / Recurso (1 mes)</title>
<link rel="stylesheet" href="style.css">
<style>
.page-head{background:#fff;border-bottom:1px solid var(--c-border)}
.page-head .container{display:flex;align-items:center;gap:12px;padding:12px var(--gap)}
.brand{display:flex;align-items:center;gap:10px;font-weight:900;color:var(--c-text)}
.brand-badge{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;color:var(--c-primary);background:color-mix(in srgb,var(--c-primary) 12%, #fff);border:1px solid var(--c-border)}
.grid-2{display:grid;gap:16px}
@media(min-width:1000px){ .grid-2{grid-template-columns:1fr 380px} }
fieldset{border:1px solid var(--c-border);border-radius:14px;padding:12px;background:#fff}
legend{font-weight:800;padding:0 6px}
label{display:block;margin:6px 0 4px}
input[type="text"],input[type="email"],input[type="date"],select,textarea{width:100%;height:44px;border:1px solid var(--c-border);border-radius:12px;padding:0 12px;background:#fff}
textarea{min-height:120px;padding:12px}
input[type="checkbox"],input[type="radio"]{accent-color:var(--c-secondary)}
.row-2{display:grid;gap:12px}
@media(min-width:700px){ .row-2{grid-template-columns:1fr 1fr} }
.help{color:var(--c-muted);font-size:14px}
.small-muted{font-size:12px;color:var(--c-muted)}
.hr{height:1px;background:var(--c-border);margin:10px 0}
.notice-inline{background:color-mix(in srgb,var(--c-warning) 14%, #fff);border:1px solid var(--c-border);padding:10px;border-radius:10px}
.deadline{background:#fff;border:1px dashed var(--c-border);border-radius:12px;padding:12px}
.badge-soft{display:inline-block;border-radius:999px;padding:4px 10px;font-size:12px;background:color-mix(in srgb,var(--c-primary) 10%,#fff);border:1px solid var(--c-border)}
.hp{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
</style>
</head>
<body>

<header class="page-head">
  <div class="container">
    <a href="index.html" class="brand" aria-label="Inicio">
      <div class="brand-badge">S</div><span>SGH</span>
    </a>
    <nav class="nav" aria-label="principal" style="margin-left:auto;display:flex;gap:14px;flex-wrap:wrap">
      <a href="paneles.html">Trámites</a>
      <a href="quienes-somos.html">¿Quiénes somos?</a>
      <a href="aviso-legal.html">Legal</a>
      <a href="contacto.html">Contacto</a>
    </nav>
  </div>
</header>

<section id="pdf-panel" class="card" hidden>
  <h2 style="margin:0 0 10px">Documento generado</h2>
  <div style="display:flex;gap:10px;margin:8px 0 12px">
    <button id="btnDescargar" class="btn btn-primary" type="button">Descargar PDF</button>
    <button id="btnCompartir" class="btn btn-ghost" type="button">Compartir…</button>
  </div>
  <iframe id="pdfFrame" style="width:100%;height:70vh;border:1px solid var(--c-border);border-radius:10px;background:#fff"></iframe>
</section>

<main class="container stack" style="padding:20px 0 28px">
  <section class="grid-2">

    <!-- onsubmit inline como cinturón y tirantes -->
    <form id="form-dgt" class="stack" method="POST" enctype="multipart/form-data"
          action="https://hook.eu2.make.com/pa2zsel75tqx6bhyjptpkqr2gdf4kxks"
          onsubmit="return handleDgtSubmit(event)">
      <input type="hidden" name="form_name" value="dgt_multas">
      <input type="hidden" name="timestamp_iso" id="ts">
      <input type="hidden" name="source_url" id="src">
      <input type="hidden" name="plazo_calculado" id="plazo_calculado">
      <input type="hidden" name="plazo_detalle" id="plazo_detalle">
      <input type="hidden" name="notificacion_efectiva" id="not_efectiva">
      <div class="hp"><label for="web">Si ves esto, déjalo vacío</label><input id="web" name="website"></div>

      <h1 style="margin:0">DGT · Alegaciones (20 días) / Recurso (1 mes)</h1>
      <p class="small" style="margin:0;color:var(--c-muted)">Generamos tu escrito en PDF, con checklist y enlaces a Sede DGT y REG.</p>

      <!-- … tu formulario completo aquí (tal como lo tienes) … -->

      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button id="btnSend" class="btn btn-primary" type="submit">Generar documento</button>
        <a class="btn btn-secondary" href="paneles.html">Volver al panel</a>
      </div>
      <p id="status" class="small-muted" role="status" aria-live="polite"></p>
    </form>

    <aside class="stack">
      <section class="notice"><b>Transparencia:</b> Este asistente genera un borrador. Léelo antes de firmarlo y presentarlo.</section>
    </aside>
  </section>
</main>

<footer class="footer">
  <div class="container cols">
    <div class="small">© SGH – Datos mínimos, sin publicidad ni seguimiento.</div>
    <div style="display:flex;gap:14px;flex-wrap:wrap">
      <a href="aviso-legal.html">Aviso legal</a>
      <a href="privacidad.html">Privacidad</a>
      <a href="cookies.html">Cookies</a>
      <a href="contacto.html">Contacto</a>
    </div>
  </div>
</footer>

<script>
/* mínimos de UI */
document.getElementById('ts').value = new Date().toISOString();
document.getElementById('src').value = location.href;
</script>

<!-- Librería PDF (defer para garantizar carga) -->
<script defer src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

<script>
(() => {
  'use strict';

  // Exponemos la función global para el onsubmit inline
  window.handleDgtSubmit = (e) => {
    try {
      e.preventDefault();
    } catch(_) {}
    generatePdfFlow().catch(err => {
      console.error(err);
      alert('No se pudo generar el PDF.\n\n' + (err?.message || err));
      const statusEl = document.getElementById('status');
      if (statusEl) statusEl.textContent = 'Error al generar el PDF.';
    });
    return false; // evitar envío nativo SIEMPRE
  };

  // Doble enganche por si el inline no se ejecuta
  window.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('form-dgt');
    if (form) form.addEventListener('submit', window.handleDgtSubmit);
  });

  async function generatePdfFlow(){
    const form     = document.getElementById('form-dgt');
    const btn      = document.getElementById('btnSend');
    const statusEl = document.getElementById('status');
    const pdfPanel = document.getElementById('pdf-panel');
    const pdfFrame = document.getElementById('pdfFrame');
    const btnDesc  = document.getElementById('btnDescargar');
    const btnShare = document.getElementById('btnCompartir');

    if (!form) throw new Error('No se encontró el formulario (#form-dgt).');

    const WEBHOOK_URL = form.action;

    const setBusy = (on) => {
      if (btn){ btn.disabled = on; btn.textContent = on ? 'Generando…' : 'Generar documento'; }
      if (statusEl){ statusEl.textContent = on ? 'Generando documento…' : ''; }
    };

    // Crear IFRAME “render” fuera de pantalla
    const iframe = document.createElement('iframe');
    iframe.style.position='fixed';
    iframe.style.left='-10000px';
    iframe.style.top='0';
    iframe.style.width='794px';      // A4 @96dpi
    iframe.style.minHeight='1123px';
    iframe.style.pointerEvents='none';
    iframe.style.background='#fff';
    document.body.appendChild(iframe);

    // Abrimos la ventana por adelantado para evitar bloqueos
    let pendingWin = window.open('about:blank', '_blank');

    setBusy(true);

    try {
      // anti-bot
      if (document.getElementById('web')?.value) throw new Error('Bloqueo anti-bot.');

      const fd  = new FormData(form);
      const res = await fetch(WEBHOOK_URL, { method:'POST', body: fd });

      if (!res.ok) {
        const txt = await res.text().catch(()=> '');
        throw new Error('HTTP ' + res.status + ' ' + txt);
      }

      // Parse seguro aunque ok venga como "true" (string)
      const data = await res.json().catch(()=> ({}));
      const ok = data && (data.ok === true || data.ok === 'true');
      const html = (data && data.html) ? String(data.html) : '';

      if (!ok || !html.trim()) {
        throw new Error('La respuesta no trae { ok:true, html }. Revisa el Webhook response.');
      }

      console.log('[doc_html length]', html.length);

      // Pintamos en el iframe (sin CORS gracias a srcdoc)
      iframe.srcdoc = html;
      await new Promise(res => { iframe.onload = res; setTimeout(res, 300); });

      const doc = iframe.contentDocument || iframe.contentWindow?.document;
      if (!doc) throw new Error('No se pudo acceder al documento del iframe.');
      const target = doc.body || doc.documentElement;

      // Forzamos baseline de estilos para evitar hojas en blanco
      const fix = doc.createElement('style');
      fix.textContent = `
        @page{size:A4;margin:10mm}
        html,body{background:#fff!important;color:#111!important;margin:0;padding:0}
        body{width:794px;min-height:1123px}
      `;
      doc.head.appendChild(fix);

      // Esperar fuentes/imagenes
      try { if (doc.fonts && doc.fonts.ready) await doc.fonts.ready; } catch {}
      const imgs = Array.from(doc.images || []);
      await Promise.all(imgs.map(img => img.complete ? null : new Promise(r => { img.onload=img.onerror=r; })));
      await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

      if (!target || !target.innerText.trim()) {
        throw new Error('El HTML no se pintó en el iframe (doc_html vacío).');
      }

      // Asegurar que la librería está lista
      if (typeof html2pdf === 'undefined') throw new Error('html2pdf no está cargado.');

      const opt = {
        margin: [10,10,14,10],
        filename: 'alegacion-dgt.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: {
          scale: 2, useCORS: true, allowTaint: true,
          backgroundColor: '#ffffff',
          windowWidth: Math.max(target.scrollWidth, 800),
          windowHeight: Math.max(target.scrollHeight, 1200),
          letterRendering: true
        },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };

      // Cadena estable (evita PDFs en blanco)
      const worker = html2pdf().set(opt).from(target).toCanvas().toPdf();
      const pdf = await worker.get('pdf');
      const blob = pdf.output('blob');

      // Si sospechosamente pequeño, fallback a impresión
      if (blob.size < 20000) {
        console.warn('PDF pequeño, uso fallback print(). size=', blob.size);
        const w = pendingWin && !pendingWin.closed ? pendingWin : window.open('', '_blank');
        const d = w.document;
        d.open();
        d.write(`<!doctype html><html><head><meta charset="utf-8"><title>Imprimir PDF</title>
          <style>@page{size:A4;margin:10mm}html,body{background:#fff}</style></head><body>${html}
          <script>window.onload=()=>setTimeout(()=>window.print(),300)<\/script></body></html>`);
        d.close();
        if (statusEl) statusEl.textContent = 'Abierto en modo impresión (fallback).';
        return;
      }

      // Presentación
      const url = URL.createObjectURL(blob);
      if (pendingWin && !pendingWin.closed) pendingWin.location = url; else window.open(url, '_blank');
      pendingWin = null;

      if (pdfPanel) { pdfPanel.hidden = false; if (pdfFrame) pdfFrame.src = url; }
      if (btnDesc) btnDesc.onclick = () => { const a = document.createElement('a'); a.href = url; a.download = 'alegacion-dgt.pdf'; a.click(); };
      if (btnShare) btnShare.onclick = async () => {
        try {
          const file = new File([blob], 'alegacion-dgt.pdf', { type:'application/pdf' });
          if (navigator.canShare && navigator.canShare({ files:[file] })) {
            await navigator.share({ title:'SGH · Documento DGT', text:'Te envío mi borrador en PDF.', files:[file] });
          } else {
            const txt = 'He generado mi borrador en PDF. Lo descargo y te lo adjunto.';
            window.open('https://wa.me/?text='+encodeURIComponent(txt), '_blank');
          }
        } catch(e){ alert('No se pudo compartir: ' + (e?.message || e)); }
      };

      if (statusEl) statusEl.textContent = 'Documento listo. Abierto en nueva pestaña.';
    } finally {
      setBusy(false);
    }
  }
})();
</script>

</body>
</html>
