<!doctype html>
<html lang="es-ES">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SGH | DGT · Alegaciones (20 días) / Recurso (1 mes)</title>
<link rel="stylesheet" href="style.css">
<style>
/* ——— Estilos propios de esta página (el resto viene de style.css) ——— */
.page-head{background:#fff;border-bottom:1px solid var(--c-border)}
.page-head .container{display:flex;align-items:center;gap:12px;padding:12px var(--gap)}
.brand{display:flex;align-items:center;gap:10px;font-weight:900;color:var(--c-text)}
.brand-badge{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;
  color:var(--c-primary);background:color-mix(in srgb,var(--c-primary) 12%, #fff);border:1px solid var(--c-border)}
.grid-2{display:grid;gap:16px}
@media(min-width:1000px){ .grid-2{grid-template-columns:1fr 380px} }
fieldset{border:1px solid var(--c-border);border-radius:14px;padding:12px;background:#fff}
legend{font-weight:800;padding:0 6px}
label{display:block;margin:6px 0 4px}
input[type="text"],input[type="email"],input[type="date"],select,textarea{
  width:100%;height:44px;border:1px solid var(--c-border);border-radius:12px;padding:0 12px;background:#fff
}
textarea{min-height:120px;padding:12px}
input[type="checkbox"],input[type="radio"]{accent-color:var(--c-secondary)}
.row-2{display:grid;gap:12px}
@media(min-width:700px){ .row-2{grid-template-columns:1fr 1fr} }
.help{color:var(--c-muted);font-size:14px}
.small-muted{font-size:12px;color:var(--c-muted)}
.hr{height:1px;background:var(--c-border);margin:10px 0}
.notice-inline{background:color-mix(in srgb,var(--c-warning) 14%, #fff);border:1px solid var(--c-border);padding:10px;border-radius:10px}
.deadline{background:#fff;border:1px dashed var(--c-border);border-radius:12px;padding:12px}
.badge-soft{display:inline-block;border-radius:999px;padding:4px 10px;font-size:12px;background:color-mix(in srgb,var(--c-primary) 10%,#fff);border:1px solid var(--c-border)}
.hp{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
</style>
</head>
<body>

<!-- cabecera -->
<header class="page-head">
  <div class="container">
    <a href="index.html" class="brand" aria-label="Inicio">
      <div class="brand-badge">S</div><span>SGH</span>
    </a>
    <nav class="nav" aria-label="principal" style="margin-left:auto;display:flex;gap:14px;flex-wrap:wrap">
      <a href="paneles.html">Trámites</a>
      <a href="quienes-somos.html">¿Quiénes somos?</a>
      <a href="aviso-legal.html">Legal</a>
      <a href="contacto.html">Contacto</a>
    </nav>
  </div>
</header>

<!-- PANEL PDF (se muestra tras generar) -->
<section id="pdf-panel" class="card" hidden>
  <h2 style="margin:0 0 10px">Documento generado</h2>
  <div style="display:flex;gap:10px;margin:8px 0 12px">
    <button id="btnDescargar" class="btn btn-primary" type="button">Descargar PDF</button>
    <button id="btnCompartir" class="btn btn-ghost" type="button">Compartir…</button>
  </div>
  <iframe id="pdfFrame" style="width:100%;height:70vh;border:1px solid var(--c-border);border-radius:10px;background:#fff"></iframe>
</section>

<main class="container stack" style="padding:20px 0 28px">
  <section class="grid-2">

    <!-- ======= FORMULARIO ======= -->
    <form id="form-dgt" class="stack" method="POST" enctype="multipart/form-data"
          action="https://hook.eu2.make.com/pa2zsel75tqx6bhyjptpkqr2gdf4kxks">
      <input type="hidden" name="form_name" value="dgt_multas">
      <input type="hidden" name="timestamp_iso" id="ts">
      <input type="hidden" name="source_url" id="src">
      <input type="hidden" name="plazo_calculado" id="plazo_calculado">
      <input type="hidden" name="plazo_detalle" id="plazo_detalle">
      <input type="hidden" name="notificacion_efectiva" id="not_efectiva">
      <!-- honeypot -->
      <div class="hp"><label for="web">Si ves esto, déjalo vacío</label><input id="web" name="website"></div>

      <h1 style="margin:0">DGT · Alegaciones (20 días) / Recurso (1 mes)</h1>
      <p class="small" style="margin:0;color:var(--c-muted)">
        Generamos tu escrito en PDF, con checklist y enlaces a Sede DGT y REG.
      </p>

      <fieldset>
        <legend>1) Datos personales</legend>
        <div class="row-2">
          <div><label>Nombre *</label><input name="nombre" required></div>
          <div><label>Apellidos *</label><input name="apellidos" required></div>
        </div>
        <div class="row-2">
          <div><label>DNI/NIE/CIF *</label><input name="dni" required></div>
          <div><label>Correo electrónico *</label><input type="email" name="email" required></div>
        </div>
        <label>Domicilio a efectos de notificaciones *</label>
        <input name="domicilio" required>
        <div class="row-2">
          <div><label>Localidad *</label><input name="localidad" required></div>
          <div><label>Provincia *</label><input name="provincia" required></div>
        </div>
        <label>Código postal *</label><input name="cp" required>
      </fieldset>

      <fieldset>
        <legend>2) Representación</legend>
        <div class="row-2">
          <label class="control"><input type="radio" name="actua_como" value="interesado" checked> No actúo como representante</label>
          <label class="control"><input type="radio" name="actua_como" value="representante"> Sí, represento a otra persona</label>
        </div>
        <div id="rep-box" class="stack" hidden>
          <div class="row-2">
            <div><label>Nombre del representado *</label><input name="rep_nombre"></div>
            <div><label>DNI/NIE del representado *</label><input name="rep_dni"></div>
          </div>
          <label>Autorización de representación (PDF/JPG/PNG, máx. 10MB)</label>
          <input type="file" name="rep_autorizacion" accept=".pdf,.jpg,.jpeg,.png">
        </div>
      </fieldset>

      <fieldset>
        <legend>3) Expediente</legend>
        <div class="row-2">
          <div><label>Nº de expediente DGT *</label><input name="expediente" required></div>
          <div><label>Matrícula *</label><input name="matricula" required></div>
        </div>
        <label>Tipo de trámite *</label>
        <div class="row-2">
          <label class="control"><input type="radio" name="tipo" value="alegaciones" checked> Alegaciones (20 días)</label>
          <label class="control"><input type="radio" name="tipo" value="recurso"> Recurso de reposición (1 mes)</label>
        </div>
        <div id="fecha-resol" class="stack" hidden>
          <label>Fecha de la resolución sancionadora (solo para Recurso)</label>
          <input type="date" name="fecha_resolucion">
        </div>
      </fieldset>

      <fieldset>
        <legend>4) Notificación</legend>
        <label>¿Cómo recibiste la notificación? *</label>
        <select id="canal" name="canal" required>
          <option value="" selected>— Selecciona —</option>
          <option>Boletín en el acto</option>
          <option>Postal</option>
          <option>DEV leída</option>
          <option>DEV no leída</option>
          <option>DEHú leída</option>
          <option>DEHú no leída</option>
          <option>Edictos (TEU/BOE)</option>
        </select>

        <label id="lbl-fecha">Fecha de notificación / lectura / puesta a disposición *</label>
        <input type="date" id="fecha" name="fecha_evento" required>
        <p class="small-muted">Te calculamos el plazo orientativo abajo. Verifica siempre tu documento de notificación.</p>

        <div class="deadline" id="plazoBox" hidden>
          <div><b>Notificación efectiva:</b> <span id="out-efectiva">—</span></div>
          <div><b>Plazo para presentar:</b> <span id="out-plazo">—</span> <span class="badge-soft" id="out-tipo">—</span></div>
          <div class="small-muted" id="out-detalle">—</div>
        </div>

        <div class="notice-inline small" style="margin-top:10px">
          <b>Importante:</b> este cálculo es orientativo. La normativa puede fijar <i>días hábiles</i> o <i>naturales</i>. Revisa tu notificación y, ante duda, presenta cuanto antes.
        </div>
      </fieldset>

      <fieldset>
        <legend>5) Motivos y pruebas</legend>
        <div class="row-2">
          <label class="control"><input type="checkbox" name="motivos[]" value="error_identificacion"> Error de identificación/datos</label>
          <label class="control"><input type="checkbox" name="motivos[]" value="no_conductor"> No era el conductor</label>
          <label class="control"><input type="checkbox" name="motivos[]" value="senalizacion"> Señalización deficiente</label>
          <label class="control"><input type="checkbox" name="motivos[]" value="instrumento"> Instrumento mal calibrado</label>
          <label class="control"><input type="checkbox" name="motivos[]" value="prescripcion"> Prescripción/caducidad</label>
          <label class="control"><input type="checkbox" name="motivos[]" value="circ_excepcionales"> Circunstancias excepcionales</label>
        </div>
        <label>Expón brevemente tus hechos y fundamentos (máx. 2000 caracteres)</label>
        <textarea name="relato" maxlength="2000" placeholder="Describe de forma clara y breve los hechos y por qué solicitas la estimación."></textarea>

        <label>Pruebas/archivos (PDF/JPG/PNG, máx. 10MB cada uno) <span class="help">(opcional, puedes añadir varias)</span></label>
        <input type="file" name="archivos[]" accept=".pdf,.jpg,.jpeg,.png" multiple>
      </fieldset>

      <fieldset>
        <legend>6) Confirmación</legend>
        <label class="control"><input type="checkbox" name="veracidad" required> Declaro que la información enviada es veraz y los documentos son auténticos.</label>
        <label class="control"><input type="checkbox" name="consentimiento" required> Acepto el uso de mis datos para generar y enviarme el documento.</label>
        <p class="small-muted">
          Aviso: Servicio automatizado y <b>no oficial</b> del Estado. No sustituye a profesionales (abogado, gestor o administrador). Enlaces oficiales: 
          <a href="https://sede.dgt.gob.es" target="_blank" rel="noopener">Sede DGT</a> · 
          <a href="https://rec.redsara.es" target="_blank" rel="noopener">Registro Electrónico General</a>.
        </p>
      </fieldset>

      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button id="btnSend" class="btn btn-primary" type="submit">Generar documento</button>
        <a class="btn btn-secondary" href="paneles.html">Volver al panel</a>
      </div>
      <p id="status" class="small-muted" role="status" aria-live="polite"></p>
    </form>

    <!-- ======= LATERAL ======= -->
    <aside class="stack">
      <section class="card">
        <h2 style="font-size:20px;margin:0 0 6px">Checklist</h2>
        <ul class="small" style="margin:0 0 6px;padding-left:18px">
          <li>Verifica el plazo (fecha de notificación y canal).</li>
          <li>Adjunta autorización si actúas como representante.</li>
          <li>Revisa matrícula, expediente y DNI/NIE.</li>
          <li>Ten tu certificado digital o Cl@ve para la Sede.</li>
        </ul>
        <div class="hr"></div>
        <a class="btn btn-ghost" href="https://sede.dgt.gob.es" target="_blank" rel="noopener">Ir a Sede DGT →</a>
        <a class="btn btn-ghost" href="https://rec.redsara.es" target="_blank" rel="noopener">Ir a REG →</a>
      </section>

      <section class="notice">
        <b>Transparencia:</b> Este asistente genera un borrador. Léelo antes de firmarlo y presentarlo.
      </section>
    </aside>
  </section>
</main>

<footer class="footer">
  <div class="container cols">
    <div class="small">© SGH – Datos mínimos, sin publicidad ni seguimiento.</div>
    <div style="display:flex;gap:14px;flex-wrap:wrap">
      <a href="aviso-legal.html">Aviso legal</a>
      <a href="privacidad.html">Privacidad</a>
      <a href="cookies.html">Cookies</a>
      <a href="contacto.html">Contacto</a>
    </div>
  </div>
</footer>

<!-- === Script de UI (fechas/plazos/ocultar/mostrar) === -->
<script>
document.getElementById('ts').value = new Date().toISOString();
document.getElementById('src').value = location.href;

/* representación */
const repBox = document.getElementById('rep-box');
function toggleRep(){ repBox.hidden = !document.querySelector('input[name="actua_como"][value="representante"]').checked; }
document.querySelectorAll('input[name="actua_como"]').forEach(r=>r.addEventListener('change',toggleRep)); toggleRep();

/* tipo trámite fecha resolución */
const fechaRes = document.getElementById('fecha-resol');
function toggleRes(){ fechaRes.hidden = document.querySelector('input[name="tipo"][value="recurso"]').checked ? false : true; }
document.querySelectorAll('input[name="tipo"]').forEach(r=>r.addEventListener('change',()=>{toggleRes(); calcPlazo();})); toggleRes();

/* cálculo de plazos (orientativo) */
const canal = document.getElementById('canal');
const fecha = document.getElementById('fecha');
const outEfectiva = document.getElementById('out-efectiva');
const outPlazo = document.getElementById('out-plazo');
const outTipo = document.getElementById('out-tipo');
const outDetalle = document.getElementById('out-detalle');
const plazoBox = document.getElementById('plazoBox');
const notEf = document.getElementById('not_efectiva');
const plazoCalc = document.getElementById('plazo_calculado');
const plazoDet = document.getElementById('plazo_detalle');

function parse(d){ const t = new Date(d); if(isNaN(t)) return null; t.setHours(12,0,0,0); return t; }
function fmt(d){ return d ? d.toLocaleDateString('es-ES') : '—'; }
function addDays(d,n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
function addBusinessDays(d,n){ let x=new Date(d), added=0; while(added<n){ x.setDate(x.getDate()+1); const wd=x.getDay(); if(wd!==0 && wd!==6) added++; } return x; }
function addMonthsSameDay(d,m){ const x=new Date(d), day=x.getDate(); x.setMonth(x.getMonth()+m); if(x.getDate()!==day){ x.setDate(0);} return x; }

function calcPlazo(){
  const c = canal.value, f = parse(fecha.value);
  const esRecurso = document.querySelector('input[name="tipo"][value="recurso"]').checked;
  const fResol = parse(document.querySelector('input[name="fecha_resolucion"]')?.value);
  if(!c || !f){ plazoBox.hidden=true; return; }
  let notifEf=f, detalle=[];
  if(c==='DEV no leída' || c==='DEHú no leída'){ notifEf=addDays(f,10); detalle.push('DEV/DEHú no leída: notificado al décimo día.'); }
  else if(c==='DEV leída' || c==='DEHú leída'){ detalle.push('DEV/DEHú leída: cuenta desde la lectura.'); }
  else if(c==='Boletín en el acto'){ detalle.push('Boletín en el acto: desde el día siguiente.'); }
  else if(c==='Postal'){ detalle.push('Postal: desde la recepción indicada.'); }
  else if(c==='Edictos (TEU/BOE)'){ detalle.push('Edictos: desde la publicación.'); }
  let fin, etiqueta;
  if(esRecurso){ const base=fResol||notifEf; fin=addMonthsSameDay(base,1); etiqueta='1 mes (resolución)'; detalle.push('Recurso: 1 mes desde la notificación.');}
  else{ const nat=addDays(notifEf,20), hab=addBusinessDays(notifEf,20); fin=nat; etiqueta='20 días'; detalle.push(`Alegaciones: 20 días. Naturales: ${fmt(nat)} · Hábiles aprox.: ${fmt(hab)}.`);}
  outEfectiva.textContent=fmt(notifEf); outPlazo.textContent=fmt(fin); outTipo.textContent=etiqueta; outDetalle.textContent=detalle.join(' ');
  plazoBox.hidden=false; notEf.value=notifEf.toISOString(); plazoCalc.value=fin.toISOString(); plazoDet.value=outDetalle.textContent;
}
canal.addEventListener('change', calcPlazo);
fecha.addEventListener('change', calcPlazo);
document.querySelector('input[name="fecha_resolucion"]')?.addEventListener('change', calcPlazo);
</script>

<!-- Librería html2pdf -->
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

<!-- Generación PDF robusta -->
<script>
(() => {
  'use strict';

  const form     = document.getElementById('form-dgt');
  const btn      = document.getElementById('btnSend');
  const statusEl = document.getElementById('status');
  const pdfPanel = document.getElementById('pdf-panel');
  const pdfFrame = document.getElementById('pdfFrame');
  const btnDesc  = document.getElementById('btnDescargar');
  const btnShare = document.getElementById('btnCompartir');
  if (!form) return;

  const WEBHOOK_URL = form.action;

  // IFRAME off-screen para render (no display:none)
  const iframe = document.createElement('iframe');
  iframe.style.position='fixed';
  iframe.style.left='-10000px';
  iframe.style.top='0';
  iframe.style.width='794px';      // A4 ≈ 794×1123 px a 96dpi
  iframe.style.minHeight='1123px';
  iframe.style.pointerEvents='none';
  iframe.style.background='#fff';
  document.body.appendChild(iframe);

  let lastUrl = null;
  let pendingWin = null;

  const setBusy = on => {
    if (btn){ btn.disabled = on; btn.textContent = on ? 'Generando…' : 'Generar documento'; }
    if (statusEl){ statusEl.textContent = on ? 'Generando documento…' : ''; }
  };

  async function waitForRender(doc){
    try { if (doc.fonts && doc.fonts.ready) await doc.fonts.ready; } catch {}
    const imgs = Array.from(doc.images || []);
    await Promise.all(imgs.map(img => img.complete ? null : new Promise(res => { img.onload=img.onerror=res; })));
    // 2 RAFs para asegurar layout/paint
    await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
  }

  async function buildPdfBlob(target, extraOptions = {}){
    const opt = {
      margin: [10,10,14,10],
      filename: 'alegacion-dgt.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: {
        scale: 2,
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#ffffff',
        windowWidth: Math.max(target.scrollWidth, 800),
        windowHeight: Math.max(target.scrollHeight, 1200),
        letterRendering: true,
        ...extraOptions.html2canvas
      },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    const worker = html2pdf().set(opt).from(target).toCanvas().toPdf();
    const pdf = await worker.get('pdf');
    return pdf.output('blob');
  }

  async function htmlToPdfBlob(htmlString){
    const html = String(htmlString || '');
    if (!html.trim()) throw new Error('El HTML está vacío (revisa mapeo en Make).');

    iframe.srcdoc = html;
    await new Promise(resolve => { iframe.onload = resolve; setTimeout(resolve, 300); });

    const doc = iframe.contentDocument || iframe.contentWindow?.document;
    if (!doc) throw new Error('No se pudo acceder al documento del iframe.');

    // Fuerza fondo y tamaño A4 px (evita errores con mm)
    const fix = doc.createElement('style');
    fix.textContent = `
      html,body{background:#fff!important;color:#111!important;margin:0;padding:0}
      body{width:794px;min-height:1123px}
      *{transform:translateZ(0)}
    `;
    doc.head.appendChild(fix);

    await waitForRender(doc);

    const target = doc.body || doc.documentElement;
    if (!target || !target.innerText.trim()) {
      throw new Error('El HTML no se pintó en el iframe.');
    }

    // Intento 1 (normal)
    let blob = await buildPdfBlob(target);
    if (blob && blob.size >= 20000) return blob;

    // Intento 2 (fallback con foreignObjectRendering)
    blob = await buildPdfBlob(target, { html2canvas: { foreignObjectRendering: true } });
    return blob;
  }

  function presentPdf(win, blob){
    if (lastUrl) URL.revokeObjectURL(lastUrl);
    lastUrl = URL.createObjectURL(blob);

    if (win && !win.closed) win.location = lastUrl;
    else window.open(lastUrl, '_blank');

    if (pdfPanel) { pdfPanel.hidden = false; if (pdfFrame) pdfFrame.src = lastUrl; }

    if (btnDesc) btnDesc.onclick = () => {
      const a = document.createElement('a');
      a.href = lastUrl;
      a.download = 'alegacion-dgt.pdf';
      a.click();
    };

    if (btnShare) btnShare.onclick = async () => {
      try {
        const file = new File([blob], 'alegacion-dgt.pdf', { type:'application/pdf' });
        if (navigator.canShare && navigator.canShare({ files:[file] })) {
          await navigator.share({ title:'SGH · Documento DGT', text:'Te envío mi borrador en PDF.', files:[file] });
        } else {
          const txt = 'He generado mi borrador en PDF. Lo descargo y te lo adjunto.';
          window.open('https://wa.me/?text='+encodeURIComponent(txt), '_blank');
        }
      } catch (e) { alert('No se pudo compartir: ' + (e?.message || e)); }
    };
  }

  // Fallback final: abrir ventana con el HTML y lanzar print()
  function fallbackPrint(html){
    const w = pendingWin && !pendingWin.closed ? pendingWin : window.open('', '_blank');
    const doc = w.document;
    doc.open();
    doc.write(`
      <!doctype html><html><head>
        <meta charset="utf-8">
        <title>Imprimir PDF</title>
        <style>@page{size:A4;margin:10mm} html,body{background:#fff}</style>
      </head><body>
        ${html}
        <script>window.onload=()=>setTimeout(()=>window.print(),300)</script>
      </body></html>
    `);
    doc.close();
  }

  form.addEventListener('submit', async (e) => {
    if (document.getElementById('web')?.value) { e.preventDefault(); return; } // anti-bot
    e.preventDefault();
    setBusy(true);

    // precrea pestaña para evitar bloqueos
    pendingWin = window.open('about:blank', '_blank');

    try {
      const fd  = new FormData(form);
      const res = await fetch(WEBHOOK_URL, { method:'POST', body: fd });
      if (!res.ok) {
        const txt = await res.text().catch(()=> '');
        throw new Error('HTTP ' + res.status + ' ' + txt);
      }
      const data = await res.json().catch(()=> ({}));
      if (!data || !data.ok || !data.html) {
        throw new Error('La respuesta no trae { ok:true, html }. Revisa el Webhook response.');
      }

      console.log('[doc_html length]', (data.html || '').length);
      let blob = await htmlToPdfBlob(data.html);

      // si aún es sospechosamente pequeño, usa impresión
      if (!blob || blob.size < 20000) {
        console.warn('PDF pequeño/blanco, abro fallback print(). size=', blob?.size);
        fallbackPrint(data.html);
        pendingWin = null;
        statusEl.textContent = 'Abierto en modo impresión (fallback).';
        setBusy(false);
        return;
      }

      presentPdf(pendingWin, blob);
      pendingWin = null;
      statusEl.textContent = 'Documento listo. Abierto en nueva pestaña.';
    } catch (err) {
      console.error(err);
      alert('No se pudo generar el PDF.\n\n' + (err?.message || err));
      statusEl.textContent = 'Error al generar el PDF.';
      if (pendingWin && !pendingWin.closed) pendingWin.close();
      pendingWin = null;
    } finally {
      setBusy(false);
    }
  });
})();
</script>

</body>
</html>
