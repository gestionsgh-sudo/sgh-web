<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DGT · Alegaciones / Recurso | SGH</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<header class="header">
  <div class="container">
    <a class="logo" href="index.html"><span class="logo-mark">S</span> SGH</a>
    <nav class="nav"><a href="legislacion.html">Biblioteca legal</a></nav>
  </div>
</header>

<main class="container stack">
  <section class="card">
    <h1 style="margin:0 0 8px">DGT · Alegaciones / Recurso</h1>
    <p class="small" style="margin:0 0 16px;color:var(--c-muted)">
      Rellena el formulario. Generaremos la plantilla ajustada a tu caso con referencias legales.
    </p>

    <form id="dgtForm" class="stack" enctype="multipart/form-data">
      <input type="hidden" name="form_name" value="dgt_multas" />
      <input type="hidden" name="website" value="https://gestionsgh-sudo.github.io/sgh-web/" />
      <input type="hidden" name="source_url" value="https://github.com/gestionsgh-sudo/sgh-web" />

      <div class="row">
        <div class="col" style="grid-column: span 6">
          <label>Nombre *</label>
          <input required name="nombre" autocomplete="name" />
        </div>
        <div class="col" style="grid-column: span 6">
          <label>Apellidos *</label>
          <input required name="apellidos" />
        </div>
      </div>

      <div class="row">
        <div class="col" style="grid-column: span 4">
          <label>DNI/NIE *</label>
          <input required name="dni" />
        </div>
        <div class="col" style="grid-column: span 8">
          <label>Correo electrónico *</label>
          <input type="email" required name="email" autocomplete="email" />
        </div>
      </div>

      <div class="row">
        <div class="col" style="grid-column: span 12">
          <label>Domicilio completo *</label>
          <input required name="domicilio" placeholder="Calle, número, piso..." />
        </div>
      </div>

      <div class="row">
        <div class="col" style="grid-column: span 4">
          <label>Localidad *</label>
          <input required name="localidad" />
        </div>
        <div class="col" style="grid-column: span 4">
          <label>Provincia *</label>
          <input required name="provincia" />
        </div>
        <div class="col" style="grid-column: span 4">
          <label>Código postal *</label>
          <input required name="cp" inputmode="numeric" />
        </div>
      </div>

      <div class="row">
        <div class="col" style="grid-column: span 6">
          <label>Actúas como *</label>
          <select name="actua_como" required>
            <option value="" selected disabled>Selecciona</option>
            <option value="interesado">Interesado/a</option>
            <option value="representante">Representante</option>
          </select>
        </div>
        <div class="col" style="grid-column: span 6">
          <label>Nº expediente / referencia *</label>
          <input required name="expediente" />
        </div>
      </div>

      <div class="row">
        <div class="col" style="grid-column: span 6">
          <label>Matrícula del vehículo *</label>
          <input required name="matricula" />
        </div>
        <div class="col" style="grid-column: span 6">
          <label>Tipo de escrito *</label>
          <select name="tipo" required>
            <option value="" disabled selected>Selecciona</option>
            <option value="alegaciones">Alegaciones</option>
            <option value="recurso">Recurso de reposición</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="col" style="grid-column: span 4">
          <label>Canal de notificación *</label>
          <select name="canal" required>
            <option value="" disabled selected>Selecciona</option>
            <option>DEV no leída</option>
            <option>DEV leída</option>
            <option>Postal</option>
          </select>
        </div>
        <div class="col" style="grid-column: span 4">
          <label>Fecha del hecho *</label>
          <input type="date" required name="fecha_evento" />
        </div>
        <div class="col" style="grid-column: span 4">
          <label>Fecha resolución (si la hay)</label>
          <input type="date" name="fecha_resolucion" />
        </div>
      </div>

      <details class="card" style="background:#fbfdff">
        <summary><b>¿Eres representante?</b> (opcional)</summary>
        <div class="row" style="margin-top:10px">
          <div class="col" style="grid-column: span 6">
            <label>Nombre del representado</label>
            <input name="rep_nombre" />
          </div>
          <div class="col" style="grid-column: span 6">
            <label>DNI del representado</label>
            <input name="rep_dni" />
          </div>
          <div class="col" style="grid-column: span 12">
            <label>Autorización (PDF/JPG) </label>
            <input type="file" name="rep_autorizacion" accept=".pdf,.jpg,.jpeg,.png" />
          </div>
        </div>
      </details>

      <div class="card" style="background:#fbfdff">
        <label style="display:block;margin-bottom:6px"><b>Motivos que aplican</b> (marca los que procedan)</label>
        <div class="bullets">
          <label><input type="checkbox" name="motivos[]" value="no_conductor" /> No era el conductor</label>
          <label><input type="checkbox" name="motivos[]" value="senalizacion" /> Señalización deficiente</label>
          <label><input type="checkbox" name="motivos[]" value="metrologia" /> Error de metrología / calibración</label>
          <label><input type="checkbox" name="motivos[]" value="defectos_formales" /> Defectos formales / falta de motivación</label>
        </div>
      </div>

      <div class="stack">
        <label>Relato de hechos *</label>
        <textarea required name="relato" rows="6" placeholder="Describe lo ocurrido..."></textarea>
      </div>

      <div class="stack">
        <label>Anexos (opcional, varios archivos)</label>
        <input type="file" name="archivos[]" multiple accept=".pdf,.jpg,.jpeg,.png" />
      </div>

      <div class="stack">
        <label class="small"><input type="checkbox" required name="veracidad" /> Declaro que la información aportada es veraz.</label>
        <label class="small"><input type="checkbox" required name="consentimiento" /> Acepto la Política de Privacidad y el Aviso legal.</label>
      </div>

      <div class="row">
        <div class="col" style="grid-column: span 6">
          <button class="btn btn-primary" type="submit" id="btnEnviar">Generar plantilla</button>
        </div>
        <div class="col" style="grid-column: span 6; text-align:right">
          <a class="btn btn-secondary" href="legislacion.html">Ver base legal</a>
        </div>
      </div>
    </form>

    <!-- Resultado -->
    <div id="resultado" class="card" style="display:none;margin-top:16px">
      <h3 style="margin:0 0 8px">Plantilla generada</h3>
      <p class="small" id="resultadoMsg">Tu documento está listo.</p>
      <div class="row">
        <div class="col" style="grid-column: span 4"><a id="btnDescargar" class="btn btn-primary" download>Descargar PDF</a></div>
        <div class="col" style="grid-column: span 4"><a id="btnWhats" class="btn btn-secondary" target="_blank" rel="noopener">Enviar por WhatsApp</a></div>
        <div class="col" style="grid-column: span 4"><a id="btnGmail" class="btn btn-secondary" target="_blank" rel="noopener">Enviar por Gmail</a></div>
      </div>
      <small class="small">También recibirás un email con instrucciones.</small>
    </div>
  </section>
</main>

<script>
  // 1) Pega aquí tu webhook de Make (el de dgt_multas)
  const MAKE_WEBHOOK_URL = "https://hook.eu2.make.com/XXXXXXXXXXXXXXXXXXXXXXXX";

  // 2) Envío del formulario a Make y gestión de la respuesta
  const f = document.getElementById('dgtForm');
  const btn = document.getElementById('btnEnviar');
  const box = document.getElementById('resultado');
  const msg = document.getElementById('resultadoMsg');
  const aPdf = document.getElementById('btnDescargar');
  const aWsp = document.getElementById('btnWhats');
  const aGml = document.getElementById('btnGmail');

  f.addEventListener('submit', async (e)=>{
    e.preventDefault();
    btn.disabled = true; btn.textContent = "Generando…";
    const data = new FormData(f);

    try{
      const res = await fetch(MAKE_WEBHOOK_URL, { method: 'POST', body: data });
      // Esperamos un JSON con: { ok:true, pdf_url:"...", file_name:"..." }
      let out;
      const ct = res.headers.get('content-type')||'';
      if(ct.includes('application/json')){
        out = await res.json();
      }else{
        // fallback: texto -> intentar parsear
        const t = await res.text();
        try{ out = JSON.parse(t) }catch{ out = { ok:res.ok, raw:t } }
      }

      // Si tu escenario ahora mismo no responde JSON,
      // puedes “simular” un link usando tu Make/Drive/etc.
      // out.pdf_url debe ser una URL directa descargable al PDF generado.
      if(out && out.pdf_url){
        msg.textContent = "Documento listo. Revisa y firma.";
        aPdf.href = out.pdf_url;
        aWsp.href = `https://wa.me/?text=${encodeURIComponent("Te comparto mi alegación/recurso DGT generada por SGH: "+out.pdf_url)}`;
        aGml.href = `https://mail.google.com/mail/?view=cm&fs=1&su=${encodeURIComponent("Alegación/Rec. DGT")}&body=${encodeURIComponent("Enlace al documento: "+out.pdf_url)}`;
        box.style.display = 'block';
        box.scrollIntoView({behavior:'smooth'});
      }else{
        msg.textContent = "Enviado. Recibirás el documento por correo.";
        box.style.display = 'block';
      }
    }catch(err){
      alert("No se pudo enviar. Comprueba conexión o el webhook de Make.");
      console.error(err);
    }finally{
      btn.disabled = false; btn.textContent = "Generar plantilla";
    }
  });
</script>
</body>
</html>
